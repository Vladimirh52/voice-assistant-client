<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–æ–ª–æ—Å–æ–≤–æ–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç (–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f9;
            color: #333;
        }
        #controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        button {
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #startButton {
            background-color: #5cb85c;
            color: white;
        }
        #startButton.recording {
            background-color: #d9534f;
        }
        #status {
            margin-top: 20px;
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            min-height: 25px;
        }
        #log {
            margin-top: 30px;
            width: 80%;
            max-width: 600px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <h1>–ì–æ–ª–æ—Å–æ–≤–æ–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç (–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π)</h1>
    <div id="controls">
        <button id="startButton">–ù–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥</button>
        <div id="status">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </div>
    
    <div id="log">
        <div class="log-entry"><strong>–õ–æ–≥:</strong></div>
    </div>

    <script>
        // *** 1. –í–ê–ñ–ù–û: –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø GROQ ***
        // üö® –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–® –ö–õ–Æ–ß API GROQ
        const GROQ_API_KEY = "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"; 
        const GROQ_URL = "https://api.groq.com/openai/v1/chat/completions";
        const GROQ_MODEL = "llama-3.1-8b-instant";
        
        // --- 2. –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢ (–¥–ª—è Groq) ---
        const SYSTEM_PROMPT = `
            –¢—ã ‚Äî —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–º–Ω—ã–º –¥–æ–º–æ–º.
            –¢—ã –¥–æ–ª–∂–µ–Ω –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤–µ—Ä–Ω—É—Ç—å –µ–≥–æ –≤ —Å—Ç—Ä–æ–≥–æ–º JSON-—Ñ–æ—Ä–º–∞—Ç–µ.
            –¢—ã –ù–ò–ö–û–ì–î–ê –Ω–µ –æ—Ç–≤–µ—á–∞–µ—à—å —Ç–µ–∫—Å—Ç–æ–º. –¢–û–õ–¨–ö–û –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—à—å JSON-–æ–±—ä–µ–∫—Ç.

            –î–û–°–¢–£–ü–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø (ACTIONS):
            1. 'turn_on_light': –í–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç.
            2. 'turn_off_light': –í—ã–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç.
            3. 'set_temp': –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É.
            4. 'play_media': –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –º–µ–¥–∏–∞ (–≤–∏–¥–µ–æ/–º—É–∑—ã–∫–∞).
            5. 'none': –ù–µ—Ç —è–≤–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.

            –§–û–†–ú–ê–¢ JSON:
            {"action": "<–æ–¥–Ω–æ –∏–∑ –¥–µ–π—Å—Ç–≤–∏–π>", "target": "<–æ–±—ä–µ–∫—Ç: '–∫—É—Ö–Ω—è', '—Å–ø–∞–ª—å–Ω—è', '—Ç–µ—Ä–º–æ—Å—Ç–∞—Ç', '–Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ', 'none'>", "value": "<–∑–Ω–∞—á–µ–Ω–∏–µ: '22', 'youtube', 'none'>"}
            
            –ü—Ä–∏–º–µ—Ä:
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –í–∫–ª—é—á–∏ –Ω–∞ —é—Ç—É–±–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–ª–∏–ø Queen.
            –û—Ç–≤–µ—Ç: {"action": "play_media", "target": "–ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–ª–∏–ø Queen", "value": "youtube"}
        `;
        // ------------------------------------------

        const startButton = document.getElementById('startButton');
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');

        let recognition = null;
        let isRecording = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
        function initializeRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                statusDiv.textContent = '–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –í–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.';
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞
            if (GROQ_API_KEY === "–í–ê–®_–ö–õ–Æ–ß_GROQ_API") {
                statusDiv.textContent = '–û–®–ò–ë–ö–ê: –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—Å—Ç–∞–≤—å—Ç–µ –í–∞—à Groq API –∫–ª—é—á –≤ —Ñ–∞–π–ª index.html!';
                logMessage('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ö–ª—é—á Groq –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.', 'red');
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.continuous = false; 
            recognition.interimResults = false; 
            recognition.lang = 'ru-RU'; 

            recognition.onstart = function() {
                isRecording = true;
                startButton.textContent = '–ì–æ–≤–æ—Ä–∏—Ç–µ... (–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å)';
                startButton.classList.add('recording');
                statusDiv.textContent = '–°–ª—É—à–∞—é...';
                logMessage('–ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞...');
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                statusDiv.textContent = '–ó–∞–ø—Ä–æ—Å: ' + transcript;
                logMessage('–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: ' + transcript, 'blue');
                sendQueryToGroq(transcript); // –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ Groq
            };

            recognition.onend = function() {
                isRecording = false;
                startButton.textContent = '–ù–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥';
                startButton.classList.remove('recording');
            };

            recognition.onerror = function(event) {
                isRecording = false;
                startButton.textContent = '–ù–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥';
                startButton.classList.remove('recording');
                if (event.error === 'not-allowed') {
                    statusDiv.textContent = '–û—à–∏–±–∫–∞: –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞.';
                    logMessage('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.', 'red');
                } else if (event.error !== 'no-speech') {
                    statusDiv.textContent = '–û—à–∏–±–∫–∞: ' + event.error;
                    logMessage('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ' + event.error, 'red');
                } else {
                    statusDiv.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ...';
                    logMessage('–¢–∏—à–∏–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'orange');
                }
            };
        }

        // --- –õ–û–ì–ò–ö–ê: –ü–†–Ø–ú–û–ô –ó–ê–ü–†–û–° –ö GROQ API ---
        async function sendQueryToGroq(query) {
            statusDiv.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ Groq API...';
            logMessage('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞–ø—Ä—è–º—É—é –≤ Groq...', 'orange');
            try {
                const payload = {
                    model: GROQ_MODEL,
                    messages: [
                        { role: "system", content: SYSTEM_PROMPT },
                        { role: "user", content: query }
                    ],
                    response_format: { type: "json_object" },
                    temperature: 0.0
                };

                const response = await fetch(GROQ_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} (–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á –∏ –º–æ–¥–µ–ª—å)`);
                }

                const groqData = await response.json();
                // –ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ –∏–∑ JSON-—Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—É—é –≤–µ—Ä–Ω—É–ª Groq
                const contentStr = groqData.choices[0].message.content;
                const jsonResponse = JSON.parse(contentStr);

                // --- 3. –û–ó–í–£–ß–ò–í–ê–ù–ò–ï –û–¢–í–ï–¢–ê (TTS) ---
                const confirmationMessage = generateConfirmation(jsonResponse);
                speakText(confirmationMessage);
                
                statusDiv.textContent = `–ì–æ—Ç–æ–≤–æ! –î–µ–π—Å—Ç–≤–∏–µ: ${jsonResponse.action} (${jsonResponse.target})`;
                logMessage('–ü–æ–ª—É—á–µ–Ω JSON: ' + JSON.stringify(jsonResponse, null, 2), 'green');

                handleSmartHomeAction(jsonResponse);

            } catch (error) {
                statusDiv.textContent = '–û—à–∏–±–∫–∞ API: ' + error.message;
                logMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ Groq: ' + error.message, 'red');
            }
        }
        // ----------------------------------------------------

        // --- –§–£–ù–ö–¶–ò–ò –û–ó–í–£–ß–ò–í–ê–ù–ò–Ø ---
        function speakText(text) {
            if ('speechSynthesis' in window) {
                // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –æ–∑–≤—É—á–∏–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
                window.speechSynthesis.cancel(); 
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ru-RU'; 
                window.speechSynthesis.speak(utterance);
            } else {
                logMessage('–û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ (TTS) –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.', 'orange');
            }
        }

        function generateConfirmation(jsonAction) {
            const action = jsonAction.action;
            const target = jsonAction.target;
            const value = jsonAction.value;

            switch (action) {
                case 'turn_on_light':
                    return `–í–∫–ª—é—á–∞—é —Å–≤–µ—Ç –≤ ${target}.`;
                case 'turn_off_light':
                    return `–í—ã–∫–ª—é—á–∞—é —Å–≤–µ—Ç –≤ ${target}.`;
                case 'set_temp':
                    return `–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É ${value} –≥—Ä–∞–¥—É—Å–æ–≤.`;
                case 'play_media':
                    if (target === 'none') {
                        return '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å.';
                    }
                    return `–ò—â—É –∏ –∑–∞–ø—É—Å–∫–∞—é ${target}.`;
                case 'none':
                    return `–Ø –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª–∞ –∫–æ–º–∞–Ω–¥—É –¥–ª—è —É–º–Ω–æ–≥–æ –¥–æ–º–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ.`;
                default:
                    return '–ö–æ–º–∞–Ω–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞.';
            }
        }
        // ------------------------------------------

        // --- –õ–û–ì–ò–ö–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –£–ú–ù–´–ú –î–û–ú–û–ú ---
        function handleSmartHomeAction(action) {
            const actionType = action.action;
            const target = action.target;
            const value = action.value;
            
            // 1. –ö–æ–º–∞–Ω–¥—ã –°–í–ï–¢ / –¢–ï–ú–ü–ï–†–ê–¢–£–†–ê
            if (actionType === 'turn_on_light' || actionType === 'turn_off_light' || actionType === 'set_temp') {
                const api_endpoint = "URL_–í–ê–®–ï–ì–û_API_–£–ú–ù–û–ì–û_–î–û–ú–ê_–î–õ–Ø_–°–í–ï–¢–ê_–¢–ï–ú–ü–ï–†–ê–¢–£–†–´";
                const command_data = { action: actionType, target: target, value: value };
                
                logMessage(`[COMMAND] –û—Ç–ø—Ä–∞–≤–∫–∞ ${actionType} –¥–ª—è ${target}...`, 'blue');
                // *** –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–æ–¥ fetch() –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã –≤–∞—à–µ–º—É —Ö–∞–±—É (Home Assistant, Majordomo –∏ —Ç.–ø.)
                // fetch(api_endpoint, { method: 'POST', body: JSON.stringify(command_data) });

            // 2. –ö–æ–º–∞–Ω–¥—ã –ú–ï–î–ò–ê (YouTube)
            } else if (actionType === 'play_media') {
                const platform = value || 'youtube';
                const media_title = target;
                const api_endpoint = "URL_–í–ê–®–ï–ì–û_API_–£–ú–ù–û–ì–û_–î–û–ú–ê_–î–õ–Ø_–ú–ï–î–ò–ê"; 
                
                const command_data = { media: media_title, platform: platform };

                logMessage(`[MEDIA COMMAND] –û—Ç–ø—Ä–∞–≤–∫–∞: ${media_title} –Ω–∞ ${platform}...`, 'purple');
                // *** –ó–¥–µ—Å—å –±—É–¥–µ—Ç fetch() –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ Smart TV –∏–ª–∏ Chromecast
                // fetch(api_endpoint, { method: 'POST', body: JSON.stringify(command_data) });

            } else {
                // –î–µ–π—Å—Ç–≤–∏–µ 'none'
                console.log("No smart home action required.");
            }
            
            // –ó–ê–ì–õ–£–®–ö–ê (—É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö API)
            const message = `–°–∏–º—É–ª—è—Ü–∏—è: ${actionType} ${target} –Ω–∞ ${value}`;
            console.log(message);
        }
        // ------------------------------------------

        // –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        function logMessage(message, color = 'black') {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span style="color: ${color};">${message.replace(/\n/g, '<br>')}</span>`;
            
            logDiv.insertBefore(entry, logDiv.children[1]);
            
            while (logDiv.children.length > 12) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏
        startButton.addEventListener('click', () => {
            if (!recognition) {
                initializeRecognition();
                if (!recognition) return;
            }

            if (isRecording) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

        window.onload = initializeRecognition;
    </script>
</body>
</html>
